name: Build Arch Linux WSL from GitLab

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´02:00æ‰§è¡Œ (åŒ—äº¬æ—¶é—´10:00)
    - cron: '0 2 * * *'
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    permissions:
      contents: write
      packages: write
    outputs:
      image-version: ${{ steps.version.outputs.image-version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Arch Linux environment
        run: |
          # æ›´æ–°åŒ…ç®¡ç†å™¨
          pacman -Sy --noconfirm
          
          # å®‰è£…åŸºç¡€å·¥å…·
          pacman -S --noconfirm \
            base-devel \
            git \
            curl \
            wget \
            tar \
            xz \
            gzip \
            make \
            devtools \
            fakechroot \
            fakeroot

      - name: Generate version
        id: version
        run: |
          IMAGE_VERSION=$(date +'%Y.%m.%d.%H%M%S')
          echo "image-version=${IMAGE_VERSION}" >> $GITHUB_OUTPUT
          echo "IMAGE_VERSION=${IMAGE_VERSION}" >> $GITHUB_ENV

      - name: Free disk space
        run: |
          df -h
          # åœ¨å®¹å™¨ä¸­æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶
          pacman -Scc --noconfirm || true
          df -h

      - name: Clone GitLab archlinux-wsl project
        run: |
          git clone https://gitlab.archlinux.org/archlinux/archlinux-wsl.git gitlab-source
          cd gitlab-source
          echo "Git clone completed successfully"
          ls -la

      - name: Build archlinux-wsl using make
        run: |
          cd gitlab-source
          echo "Starting make build with IMAGE_VERSION=${IMAGE_VERSION}"
          # ä½¿ç”¨åŸç”Ÿçš„ Makefile è¿›è¡Œæ„å»º
          make IMAGE_VERSION="${IMAGE_VERSION}"
          echo "Make build completed"

      - name: List generated files
        run: |
          cd gitlab-source
          echo "=== Listing workdir contents ==="
          find workdir -type f -name "*.wsl" -o -name "*.tar.gz" -o -name "*.sha256" 2>/dev/null || echo "No build artifacts found in workdir"
          echo "=== Listing all .wsl files ==="
          find . -type f -name "*.wsl" 2>/dev/null || echo "No .wsl files found"
          echo "=== Listing output directory ==="
          if [ -d "workdir/output" ]; then
            ls -la workdir/output/
          else
            echo "workdir/output directory not found"
          fi

      - name: Copy build artifacts
        run: |
          cd gitlab-source
          mkdir -p ../artifacts
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶æ‰€æœ‰æ„å»ºäº§ç‰©
          if [ -d "workdir/output" ]; then
            echo "Copying from workdir/output"
            cp workdir/output/*.wsl ../artifacts/ 2>/dev/null || echo "No .wsl files in workdir/output"
            cp workdir/output/*.tar.gz ../artifacts/ 2>/dev/null || echo "No .tar.gz files in workdir/output"
            cp workdir/output/*.sha256 ../artifacts/ 2>/dev/null || echo "No .sha256 files in workdir/output"
          fi
          
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ï¼Œå°è¯•åœ¨å…¶ä»–ä½ç½®æŸ¥æ‰¾
          if [ ! -f ../artifacts/*.wsl ] 2>/dev/null; then
            echo "Searching for .wsl files in current directory"
            find . -name "*.wsl" -exec cp {} ../artifacts/ \; 2>/dev/null || echo "No .wsl files found"
          fi
          
          echo "=== Final artifacts directory ==="
          ls -la ../artifacts/

      - name: Verify build artifacts
        run: |
          if [ ! -f artifacts/*.wsl ] 2>/dev/null; then
            echo "ERROR: No .wsl files found in artifacts"
            echo "Build may have failed. Let's check the GitLab source directory:"
            cd gitlab-source
            find . -type f -name "*archlinux*" | head -20
            exit 1
          fi
          echo "Build artifacts verified successfully"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: archlinux-wsl-${{ steps.version.outputs.image-version }}
          path: |
            artifacts/*.wsl
            artifacts/*.tar.gz
            artifacts/*.sha256
          retention-days: 30

  release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: archlinux-wsl-${{ needs.build.outputs.image-version }}
          path: ./release-artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.build.outputs.image-version }}
          name: Arch Linux WSL ${{ needs.build.outputs.image-version }}
          body: |
            # Arch Linux WSL ${{ needs.build.outputs.image-version }}
            
            ğŸ§ åŸºäº GitLab å®˜æ–¹ archlinux-wsl é¡¹ç›®æ„å»ºçš„æœ€æ–° Arch Linux WSL å‘è¡Œç‰ˆ
            
            ## ğŸ“¥ ä¸‹è½½æ–‡ä»¶
            - **`archlinux-${{ needs.build.outputs.image-version }}.wsl`** - WSL å¯¼å…¥æ–‡ä»¶ï¼ˆæ¨èï¼‰
            - **`archlinux-${{ needs.build.outputs.image-version }}.tar.gz`** - æ ‡å‡† tar.gz æ ¼å¼
            - **`*.sha256`** - æ ¡éªŒå’Œæ–‡ä»¶
            
            ## ğŸš€ å®‰è£…æ–¹æ³•
            
            ### ä½¿ç”¨ .wsl æ–‡ä»¶ (æ¨è)
            ```powershell
            # ä¸‹è½½ .wsl æ–‡ä»¶å
            wsl --import ArchLinux C:\\WSL\\ArchLinux archlinux-${{ needs.build.outputs.image-version }}.wsl
            wsl --set-default ArchLinux
            wsl -d ArchLinux
            ```
            
            ### ä½¿ç”¨ .tar.gz æ–‡ä»¶
            ```powershell
            # ä¸‹è½½ .tar.gz æ–‡ä»¶å
            wsl --import ArchLinux C:\\WSL\\ArchLinux archlinux-${{ needs.build.outputs.image-version }}.tar.gz
            wsl --set-default ArchLinux
            wsl -d ArchLinux
            ```
            
            ## âœ¨ ç‰¹æ€§
            - âœ… **åŸç”Ÿ Arch Linux æ„å»º** - ä½¿ç”¨ Arch Linux å®¹å™¨å’ŒåŸç”Ÿå·¥å…·é“¾
            - âœ… **æœ€æ–° Arch Linux** - åŸºäºæœ€æ–°å®˜æ–¹é•œåƒ
            - âœ… **å®Œæ•´ç³»ç»Ÿ** - åŒ…å« systemd æ”¯æŒå’Œå®Œæ•´çš„åŒ…ç®¡ç†
            - âœ… **å¼€å‘å‹å¥½** - é¢„è£…å¸¸ç”¨å¼€å‘å·¥å…·
            - âœ… **WSL ä¼˜åŒ–** - é’ˆå¯¹ WSL ç¯å¢ƒä¼˜åŒ–é…ç½®
            
            ## ğŸ” æ–‡ä»¶éªŒè¯
            ```bash
            # Windows (PowerShell)
            Get-FileHash archlinux-${{ needs.build.outputs.image-version }}.wsl -Algorithm SHA256
            
            # Linux/macOS
            sha256sum archlinux-${{ needs.build.outputs.image-version }}.wsl
            ```
            
            ## ğŸ“‹ ç³»ç»Ÿä¿¡æ¯
            - **åŒ…ç®¡ç†å™¨**: `pacman`
            - **ç³»ç»Ÿæ¶æ„**: `x86_64`
            - **Locale**: `en_US.UTF-8`
            - **Init ç³»ç»Ÿ**: `systemd`
            
            ## ğŸ”§ é¦–æ¬¡ä½¿ç”¨å»ºè®®
            ```bash
            # æ›´æ–°ç³»ç»Ÿ
            sudo pacman -Syu
            
            # å®‰è£… AUR helper (å¯é€‰)
            git clone https://aur.archlinux.org/yay.git
            cd yay && makepkg -si
            
            # é…ç½® Git (å¦‚éœ€è¦)
            git config --global user.name "Your Name"
            git config --global user.email "your.email@example.com"
            ```
            
            ---
            ğŸ“… **æ„å»ºæ—¶é—´**: ${{ github.run_id }}  
            ğŸ”— **æäº¤**: [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})  
            ğŸ¤– **è‡ªåŠ¨æ„å»º**: GitHub Actions (Arch Linux å®¹å™¨)  
            ğŸ—ï¸ **æºé¡¹ç›®**: [archlinux-wsl](https://gitlab.archlinux.org/archlinux/archlinux-wsl)
          files: |
            ./release-artifacts/*.wsl
            ./release-artifacts/*.tar.gz
            ./release-artifacts/*.sha256
          draft: false
          prerelease: false

  cleanup:
    runs-on: ubuntu-latest
    needs: [release]
    if: github.event_name == 'schedule'
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Delete old releases
        uses: actions/github-script@v7
        with:
          script: |
            // è·å–æ‰€æœ‰ releases
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            // ä¿ç•™æœ€æ–°çš„ 10 ä¸ª releaseï¼Œåˆ é™¤å…¶ä»–çš„
            const releasesToDelete = releases.data.slice(10);
            
            for (const release of releasesToDelete) {
              if (release.tag_name.startsWith('v')) {
                console.log(`æ­£åœ¨åˆ é™¤æ—§ç‰ˆæœ¬ ${release.tag_name}`);
                try {
                  await github.rest.repos.deleteRelease({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    release_id: release.id
                  });
                  
                  // åˆ é™¤å¯¹åº”çš„ tag
                  await github.rest.git.deleteRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: `tags/${release.tag_name}`
                  });
                  
                  console.log(`å·²åˆ é™¤ç‰ˆæœ¬ ${release.tag_name}`);
                } catch (error) {
                  console.log(`åˆ é™¤ç‰ˆæœ¬ ${release.tag_name} æ—¶å‡ºé”™: ${error.message}`);
                }
              }
            }
            
            console.log('æ¸…ç†å®Œæˆï¼ä¿ç•™äº†æœ€æ–°çš„ 10 ä¸ªç‰ˆæœ¬ã€‚');
