name: Build Arch Linux WSL

on:
  schedule:
    # 每天UTC时间02:00执行 (北京时间10:00)
    - cron: '0 2 * * *'
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Generate version
      id: version
      run: |
        VERSION=$(date +'%Y.%m.%d')
        BUILD_NUM=$(date +'%H%M')
        FULL_VERSION="${VERSION}.${BUILD_NUM}"
        echo "version=${FULL_VERSION}" >> $GITHUB_OUTPUT
        echo "date=${VERSION}" >> $GITHUB_OUTPUT
        
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        df -h
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Create build directory
      run: |
        mkdir -p workdir/output
        
    - name: Build Arch Linux rootfs
      run: |
        # 使用Docker创建Arch Linux根文件系统
        docker run --rm --privileged \
          -v "$(pwd)/workdir:/workdir" \
          archlinux:latest \
          bash -c "
            # 更新系统
            pacman -Syu --noconfirm
            
            # 安装基础包
            pacman -S --needed --noconfirm \
              base \
              base-devel \
              sudo \
              vim \
              nano \
              git \
              curl \
              wget \
              htop \
              neofetch \
              openssh \
              networkmanager \
              systemd-sysvcompat
            
            # 创建用户
            useradd -m -G wheel -s /bin/bash archuser
            echo 'archuser ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
            
            # 配置locale
            echo 'en_US.UTF-8 UTF-8' > /etc/locale.gen
            locale-gen
            echo 'LANG=en_US.UTF-8' > /etc/locale.conf
            
            # WSL配置
            echo '[boot]' > /etc/wsl.conf
            echo 'systemd=true' >> /etc/wsl.conf
            echo '[user]' >> /etc/wsl.conf
            echo 'default=archuser' >> /etc/wsl.conf
            
            # 创建tar包
            tar -czf /workdir/output/archlinux-${{ steps.version.outputs.version }}.tar.gz \
              --exclude=/proc/* \
              --exclude=/sys/* \
              --exclude=/dev/* \
              --exclude=/tmp/* \
              --exclude=/workdir \
              /
          "
          
    - name: Generate checksums
      run: |
        cd workdir/output
        sha256sum *.tar.gz > checksums.sha256
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: archlinux-wsl-${{ steps.version.outputs.version }}
        path: |
          workdir/output/*.tar.gz
          workdir/output/checksums.sha256
        retention-days: 30

  release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'schedule' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Generate version
      id: version
      run: |
        VERSION=$(date +'%Y.%m.%d')
        BUILD_NUM=$(date +'%H%M')
        FULL_VERSION="${VERSION}.${BUILD_NUM}"
        echo "version=${FULL_VERSION}" >> $GITHUB_OUTPUT
        
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: archlinux-wsl-${{ steps.version.outputs.version }}
        path: ./artifacts
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: Arch Linux WSL ${{ steps.version.outputs.version }}
        body: |
          # Arch Linux WSL ${{ steps.version.outputs.version }}
          
          自动化构建的Arch Linux WSL发行版
          
          ## 安装方法
          
          1. 下载 `archlinux-${{ steps.version.outputs.version }}.tar.gz`
          2. 导入WSL: `wsl --import ArchLinux C:\path\to\install archlinux-${{ steps.version.outputs.version }}.tar.gz`
          3. 设为默认: `wsl --set-default ArchLinux`
          
          ## 功能特性
          
          - ✅ 最新的Arch Linux软件包
          - ✅ 预配置用户 `archuser` 拥有sudo权限
          - ✅ 启用systemd
          - ✅ 包含常用开发工具
          - ✅ 针对WSL环境优化
          
          ## 验证
          
          使用 `sha256sum` 验证文件完整性
          
          ---
          
          构建时间: ${{ github.run_id }}
          提交: ${{ github.sha }}
        files: |
          ./artifacts/*.tar.gz
          ./artifacts/checksums.sha256
        draft: false
        prerelease: false
