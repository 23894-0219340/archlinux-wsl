name: Build Arch Linux WSL

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´02:00æ‰§è¡Œ (åŒ—äº¬æ—¶é—´10:00)
    - cron: '0 2 * * *'
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - 'rootfs/**'
      - '.github/workflows/**'
      - 'Makefile'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild'
        required: false
        default: false
        type: boolean

env:
  IMAGE_VERSION_MAJOR: '2025'
  IMAGE_VERSION_MINOR: '04'
  IMAGE_VERSION_PATCH: '01'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    outputs:
      image-version: ${{ steps.version.outputs.image-version }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Generate version
      id: version
      run: |
        BUILD_ID=$(date +'%y%m%d%H%M%S')
        IMAGE_VERSION="${{ env.IMAGE_VERSION_MAJOR }}.${{ env.IMAGE_VERSION_MINOR }}.${{ env.IMAGE_VERSION_PATCH }}.${BUILD_ID}"
        echo "image-version=${IMAGE_VERSION}" >> $GITHUB_OUTPUT
        echo "build-id=${BUILD_ID}" >> $GITHUB_OUTPUT
        echo "IMAGE_VERSION=${IMAGE_VERSION}" >> $GITHUB_ENV
        
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        df -h
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          make \
          fakechroot \
          fakeroot \
          debootstrap \
          arch-install-scripts \
          xz-utils \
          tar \
          curl \
          wget \
          gzip
          
    - name: Create working directories
      run: |
        mkdir -p workdir/{rootfs,output}
        
    - name: Build Arch Linux base system
      run: |
        # ä¸‹è½½å¹¶è§£å‹ Arch Linux åŸºç¡€ç³»ç»Ÿ
        cd workdir
        
        # ä½¿ç”¨å®˜æ–¹è„šæœ¬åˆ›å»º Arch Linux rootfs
        sudo docker run --rm --privileged \
          -v "$(pwd):/workdir" \
          archlinux:latest \
          bash -c "
            # å®‰è£…å¿…è¦å·¥å…·
            pacman -Syu --noconfirm
            pacman -S --noconfirm arch-install-scripts pacman-contrib
            
            # åˆ›å»º rootfs
            mkdir -p /workdir/rootfs
            
            # å®‰è£…åŸºç¡€ç³»ç»Ÿåˆ° rootfs
            pacstrap /workdir/rootfs \
              base \
              base-devel \
              linux-firmware \
              sudo \
              vim \
              nano \
              git \
              curl \
              wget \
              htop \
              neofetch \
              openssh \
              networkmanager \
              systemd-sysvcompat \
              man-db \
              man-pages \
              which \
              python \
              python-pip
            
            # é…ç½®ç³»ç»Ÿ
            arch-chroot /workdir/rootfs /bin/bash -c '
              # è®¾ç½®æ—¶åŒº
              ln -sf /usr/share/zoneinfo/UTC /etc/localtime
              
              # ç”Ÿæˆlocale
              echo \"en_US.UTF-8 UTF-8\" > /etc/locale.gen
              locale-gen
              echo \"LANG=en_US.UTF-8\" > /etc/locale.conf
              
              # åˆ›å»ºç”¨æˆ·
              useradd -m -G wheel -s /bin/bash archuser
              echo \"archuser ALL=(ALL) NOPASSWD:ALL\" >> /etc/sudoers
              
              # WSLé…ç½®
              cat > /etc/wsl.conf << EOF
[boot]
systemd=true

[user]
default=archuser

[interop]
enabled=true
appendWindowsPath=true

[network]
generateHosts=true
generateResolvConf=true
EOF
              
              # å¯ç”¨å¿…è¦æœåŠ¡
              systemctl enable NetworkManager
              
              # æ¸…ç†ç¼“å­˜
              pacman -Scc --noconfirm
            '
            
            # ä¿®å¤æƒé™
            chown -R 1000:1000 /workdir/rootfs/home/archuser
          "
          
    - name: Create WSL tarball
      run: |
        cd workdir/rootfs
        
        # æ’é™¤ä¸éœ€è¦çš„ç›®å½•å’Œæ–‡ä»¶
        sudo tar \
          --exclude='proc/*' \
          --exclude='sys/*' \
          --exclude='dev/*' \
          --exclude='tmp/*' \
          --exclude='run/*' \
          --exclude='mnt/*' \
          --exclude='media/*' \
          --exclude='var/cache/pacman/pkg/*' \
          --exclude='var/log/*' \
          -czf "../output/archlinux-${{ steps.version.outputs.image-version }}.tar.gz" \
          .
          
    - name: Create WSL file
      run: |
        cd workdir/output
        
        # é‡å‘½åä¸º .wsl æ–‡ä»¶ï¼ˆå®é™…ä¸Šå°±æ˜¯é‡å‘½åçš„ tar.gzï¼‰
        cp "archlinux-${{ steps.version.outputs.image-version }}.tar.gz" \
           "archlinux-${{ steps.version.outputs.image-version }}.wsl"
        
        # ç”Ÿæˆæ ¡éªŒå’Œ
        sha256sum "archlinux-${{ steps.version.outputs.image-version }}.wsl" > \
                  "archlinux-${{ steps.version.outputs.image-version }}.wsl.sha256"
        sha256sum "archlinux-${{ steps.version.outputs.image-version }}.tar.gz" > \
                  "archlinux-${{ steps.version.outputs.image-version }}.tar.gz.sha256"
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        ls -lh
        
    - name: Test WSL file integrity
      run: |
        cd workdir/output
        
        # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
        sha256sum -c "archlinux-${{ steps.version.outputs.image-version }}.wsl.sha256"
        sha256sum -c "archlinux-${{ steps.version.outputs.image-version }}.tar.gz.sha256"
        
        # éªŒè¯taræ–‡ä»¶ç»“æ„
        tar -tzf "archlinux-${{ steps.version.outputs.image-version }}.wsl" | head -20
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        if ! tar -tzf "archlinux-${{ steps.version.outputs.image-version }}.wsl" | grep -q "etc/wsl.conf"; then
          echo "ERROR: etc/wsl.conf not found in WSL image"
          exit 1
        fi
        
        if ! tar -tzf "archlinux-${{ steps.version.outputs.image-version }}.wsl" | grep -q "home/archuser"; then
          echo "ERROR: archuser home directory not found"
          exit 1
        fi
        
        echo "WSL image validation passed!"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: archlinux-wsl-${{ steps.version.outputs.image-version }}
        path: |
          workdir/output/*.wsl
          workdir/output/*.tar.gz
          workdir/output/*.sha256
        retention-days: 30

  release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: archlinux-wsl-${{ needs.build.outputs.image-version }}
        path: ./artifacts
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.build.outputs.image-version }}
        name: Arch Linux WSL ${{ needs.build.outputs.image-version }}
        body: |
          # Arch Linux WSL ${{ needs.build.outputs.image-version }}
          
          ğŸ§ æœ€æ–°æ„å»ºçš„ Arch Linux WSL å‘è¡Œç‰ˆï¼ŒåŸºäºå®˜æ–¹ Arch Linux é•œåƒåˆ¶ä½œã€‚
          
          ## ğŸ“¥ ä¸‹è½½æ–‡ä»¶
          
          - **`archlinux-${{ needs.build.outputs.image-version }}.wsl`** - WSL å¯¼å…¥æ–‡ä»¶ï¼ˆæ¨èï¼‰
          - **`archlinux-${{ needs.build.outputs.image-version }}.tar.gz`** - æ ‡å‡† tar.gz æ ¼å¼
          - **`*.sha256`** - æ ¡éªŒå’Œæ–‡ä»¶
          
          ## ğŸš€ å®‰è£…æ–¹æ³•
          
          ### æ–¹æ³• 1: ä½¿ç”¨ .wsl æ–‡ä»¶
          ```powershell
          # ä¸‹è½½ .wsl æ–‡ä»¶å
          wsl --import ArchLinux C:\WSL\ArchLinux archlinux-${{ needs.build.outputs.image-version }}.wsl
          wsl --set-default ArchLinux
          wsl -d ArchLinux
          ```
          
          ### æ–¹æ³• 2: ä½¿ç”¨ .tar.gz æ–‡ä»¶
          ```powershell
          # ä¸‹è½½ .tar.gz æ–‡ä»¶å
          wsl --import ArchLinux C:\WSL\ArchLinux archlinux-${{ needs.build.outputs.image-version }}.tar.gz
          wsl --set-default ArchLinux
          wsl -d ArchLinux
          ```
          
          ## âœ¨ ç‰¹æ€§
          
          - âœ… **æœ€æ–°çš„ Arch Linux** - åŸºäºå®˜æ–¹æœ€æ–°é•œåƒ
          - âœ… **é¢„é…ç½®ç”¨æˆ·** - `archuser` ç”¨æˆ·å…·æœ‰ sudo æƒé™
          - âœ… **systemd æ”¯æŒ** - å®Œæ•´çš„ systemd åŠŸèƒ½
          - âœ… **å¼€å‘å·¥å…·** - åŒ…å« `base-devel`ã€`git`ã€`vim` ç­‰
          - âœ… **ç½‘ç»œç®¡ç†** - é¢„è£… NetworkManager
          - âœ… **Python æ”¯æŒ** - é¢„è£… Python 3 å’Œ pip
          - âœ… **WSL ä¼˜åŒ–** - é’ˆå¯¹ WSL ç¯å¢ƒä¼˜åŒ–é…ç½®
          
          ## ğŸ” æ–‡ä»¶éªŒè¯
          
          ä¸‹è½½å®Œæˆåè¯·éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
          
          ```bash
          # Windows (PowerShell)
          Get-FileHash archlinux-${{ needs.build.outputs.image-version }}.wsl -Algorithm SHA256
          
          # Linux/macOS
          sha256sum archlinux-${{ needs.build.outputs.image-version }}.wsl
          ```
          
          ## ğŸ“‹ ç³»ç»Ÿä¿¡æ¯
          
          - **ç”¨æˆ·å**: `archuser`
          - **é»˜è®¤ Shell**: `/bin/bash`
          - **åŒ…ç®¡ç†å™¨**: `pacman`
          - **ç³»ç»Ÿæ¶æ„**: `x86_64`
          - **Locale**: `en_US.UTF-8`
          
          ## ğŸ”§ é¦–æ¬¡ä½¿ç”¨å»ºè®®
          
          ```bash
          # æ›´æ–°ç³»ç»Ÿ
          sudo pacman -Syu
          
          # å®‰è£… AUR helper (å¯é€‰)
          git clone https://aur.archlinux.org/yay.git
          cd yay && makepkg -si
          
          # é…ç½® Git (å¦‚éœ€è¦)
          git config --global user.name "Your Name"
          git config --global user.email "your.email@example.com"
          ```
          
          ---
          
          ğŸ“… **æ„å»ºæ—¶é—´**: ${{ github.run_id }}  
          ğŸ”— **æäº¤**: [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})  
          ğŸ¤– **è‡ªåŠ¨æ„å»º**: GitHub Actions
        files: |
          ./artifacts/*.wsl
          ./artifacts/*.tar.gz
          ./artifacts/*.sha256
        draft: false
        prerelease: false
        
  cleanup:
    runs-on: ubuntu-latest
    needs: [release]
    if: github.event_name == 'schedule'
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Delete old releases
      uses: actions/github-script@v7
      with:
        script: |
          // è·å–æ‰€æœ‰ releases
          const releases = await github.rest.repos.listReleases({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });
          
          // ä¿ç•™æœ€æ–°çš„ 10 ä¸ª releaseï¼Œåˆ é™¤å…¶ä»–çš„
          const releasesToDelete = releases.data.slice(10);
          
          for (const release of releasesToDelete) {
            if (release.tag_name.startsWith('v')) {
              console.log(`æ­£åœ¨åˆ é™¤æ—§ç‰ˆæœ¬ ${release.tag_name}`);
              
              try {
                await github.rest.repos.deleteRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.id
                });
                
                // åˆ é™¤å¯¹åº”çš„ tag
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `tags/${release.tag_name}`
                });
                
                console.log(`å·²åˆ é™¤ç‰ˆæœ¬ ${release.tag_name}`);
              } catch (error) {
                console.log(`åˆ é™¤ç‰ˆæœ¬ ${release.tag_name} æ—¶å‡ºé”™: ${error.message}`);
              }
            }
          }
          
          console.log('æ¸…ç†å®Œæˆï¼ä¿ç•™äº†æœ€æ–°çš„ 10 ä¸ªç‰ˆæœ¬ã€‚');
